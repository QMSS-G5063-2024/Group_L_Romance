---
title: "Combined codes copy"
author: "Priyansha Gupta"
date: "`r Sys.Date()`"
output: html_document
runtime: shiny
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(shiny)
library(DT)
library(dplyr)
library(lubridate)
library(ggplot2)
library(shinyWidgets)
library(plotly)
library(DT)         
library(knitr)      
library(tidyr)      
library(tidyverse)  
library(highcharter)
library(broom)      
library(viridis)
library(hrbrthemes)
library(readxl)
library(devtools)
library(leaflet)
library(ggthemes)
library(maps)
library(RColorBrewer)
library(sf)
```

```{r echo=FALSE, warning = FALSE}

GSS_Pri<- read_excel("Datafiles/GSS_Pri.XLSX")

```

```{r echo=FALSE, warning = FALSE}
Pri1<-GSS_Pri
Pri1<- Pri1 %>% 
  select(AGE, SEX, TRADMOD)
Pri1 <- na.omit(Pri1)
Pri1$SEX <- factor(Pri1$SEX, levels = c(1, 2), labels = c("Male", "Female"))
Pri1$TRADMOD <- factor(Pri1$TRADMOD, levels = c(1, 2), labels = c("Traditional Roles", "Equal Roles"))

plot1<-ggplot(Pri1, aes(x = TRADMOD, y = AGE, fill = SEX)) +
  geom_boxplot() +
  labs(x = "Sharing Responsibility", y = "Age", fill = "Sex") + ggtitle("Distribution of age by preference for traditional roles in relationship and sex of respondent")+
  theme_minimal()

plot1

```

```{r echo=FALSE, warning = FALSE}
Pri2<-GSS_Pri
Pri2<- Pri2 %>% 
  select(AGE, SEX, EMOTEOTH)
Pri2 <- na.omit(Pri2)

Pri2$SEX <- factor(Pri2$SEX, levels = c(1, 2), labels = c("Male", "Female"))
Pri2$EMOTEOTH <- factor(Pri2$EMOTEOTH, levels = c(1, 2), labels = c("Emotionally dependent", "Emotionally independent"))

plot2<-ggplot(Pri2, aes(x = EMOTEOTH, y = AGE, fill = SEX)) +
  geom_boxplot() +
  labs(x = "Emotional dependence", y = "Age", fill = "Sex") + ggtitle("Distribution of age by preference for emotional dependence in relationship and sex of respondent")+ 
  theme_minimal()

plot2

```

```{r echo=FALSE, warning = FALSE}
Pri3<-GSS_Pri
Pri3<- Pri3 %>% 
  select(AGE, SEX, SHARESEP)
Pri3 <- na.omit(Pri3)

Pri3$SEX <- factor(Pri3$SEX, levels = c(1, 2), labels = c("Male", "Female"))
Pri3$SHARESEP <- factor(Pri3$SHARESEP, levels = c(1, 2), labels = c("Share social life", "Individual interests"))

plot3<-ggplot(Pri3, aes(x = SHARESEP, y = AGE, fill = SEX)) +
  geom_boxplot() +
  labs(x = "Sharing social life", y = "Age", fill = "Sex") + ggtitle("Distribution of age by preference for sharing social life with partner and sex of respondent")+
  theme_minimal()

plot3
```

```{r echo=FALSE, warning = FALSE}
Pri4<-GSS_Pri
Pri4<- Pri4 %>% 
  select(AGE, SEX, PREMARSX)
Pri4 <- na.omit(Pri4)

Pri4$SEX <- factor(Pri4$SEX, levels = c(1, 2), labels = c("Male", "Female"))
Pri4$PREMARSX <- factor(Pri4$PREMARSX, levels = c(1, 2, 3, 4), labels = c("Always wrong", "Almost always wrong", "Wrong only sometimes", "Not wrong at all")) 

plot4<- ggplot(Pri4, aes(x = PREMARSX, y = AGE, fill = SEX)) +
  geom_boxplot() +
  labs(x = "Opinion on premarital sex", y = "Age", fill = "Sex") + ggtitle("Distribution of age by opinion on premarital sex and sex of respondent")+
  theme_minimal()

plot4
```

```{r}
data<- read_excel ("Datafiles/GSS_cleaned.XLSX")
```

```{r}
# Convert '9' placeholder for missing data to NA
data <- data %>%
    mutate(across(everything(), ~na_if(.x, 9)))

# Building heatmap 1 - PARTYID & FAMFINAN
chart1_data <- data %>%
    count(PARTYID, FAMFINAN, name = "Number of Respondents") %>%
    mutate(PARTYID = as.factor(PARTYID), 
           FAMFINAN = as.factor(FAMFINAN))

chart1 <- plot_ly(chart1_data, x = ~PARTYID, y = ~FAMFINAN, z = ~`Number of Respondents`, 
                  type = "heatmap", colorscale = 'Portland', hoverinfo = 'x+y+z', 
                  text = ~paste('Number of Respondents:', `Number of Respondents`)) %>%
    layout(title = "How Political Views Align with Family Finance Management",
           xaxis = list(title = "Political Affiliation", tickangle = 90),
           yaxis = list(title = "Family Finance Management Style"),
           colorbar = list(title = "Number of Respondents"))
chart1
```

```{r}
# Building heatmap 2 - PARTYID & TRADMOD
chart2_data <- data %>%
    filter(!is.na(PARTYID), !is.na(TRADMOD), TRADMOD %in% c(1, 2)) %>%
    count(PARTYID, TRADMOD, name = "Number of Respondents") %>%
    mutate(PARTYID = as.factor(PARTYID), 
           TRADMOD = factor(TRADMOD, labels = c("Man main income, woman home", "Equal responsibility")))

chart2 <- plot_ly(chart2_data, x = ~PARTYID, y = ~TRADMOD, z = ~`Number of Respondents`, 
                  type = "heatmap", colorscale = 'Portland', hoverinfo = 'x+y+z', 
                  text = ~paste('Number of Respondents:', `Number of Respondents`)) %>%
    layout(title = "Variation in Relationship Role Preferences Across Political Lines",
           xaxis = list(title = "Political Affiliation", tickangle = 90),
           yaxis = list(title = "Relationship Role Preferences"),
           colorbar = list(title = "Number of Respondents"))
chart2
```

```{r}
# Building heatmap 3 - PARTYID & PREMARSX
chart3_data <- data %>%
    filter(!is.na(PARTYID), !is.na(PREMARSX), PREMARSX %in% c(1, 2, 3, 4)) %>%
    count(PARTYID, PREMARSX, name = "Number of Respondents") %>%
    mutate(PARTYID = as.factor(PARTYID), 
           PREMARSX = factor(PREMARSX, labels = c("Always wrong", "Almost always wrong", "Wrong only sometimes", "Not wrong at all")))

chart3 <- plot_ly(chart3_data, x = ~PARTYID, y = ~PREMARSX, z = ~`Number of Respondents`, 
                  type = "heatmap", colorscale = 'Portland', hoverinfo = 'x+y+z', 
                  text = ~paste('Number of Respondents:', `Number of Respondents`)) %>%
    layout(title = "Political Stance and Opinions on Pre-Marital Sex",
           xaxis = list(title = "Political Affiliation", tickangle = 90),
           yaxis = list(title = "Views on Pre-Marital Sex"),
           colorbar = list(title = "Number of Respondents"))
chart3 
```


```{r}
df <- read.csv("Datafiles/GSS_cleaned.csv")

```

```{r}
sub <- df[, c("REGION", "FAIRHWRK", "TRADMOD", "CHLDIDEL", "REG16")]

sub$REGION[sub$REGION==1 ] <- "New England"
sub$REGION[sub$REGION==2 ] <- "Middle Atlantic"
sub$REGION[sub$REGION==3 ] <- "East North Central"
sub$REGION[sub$REGION==4 ] <- "West North Central"
sub$REGION[sub$REGION==5 ] <- "South Atlantic"
sub$REGION[sub$REGION==6 ] <- "East South Central"
sub$REGION[sub$REGION==7 ] <- "West South Central"
sub$REGION[sub$REGION==8 ] <- "Mountain"
sub$REGION[sub$REGION==9 ] <- "Pacific"

# sub$REG16[sub$REG16==0 ] <- "NA"
# sub$REG16[sub$REG16==1 ] <- "New England"
# sub$REG16[sub$REG16==2 ] <- "Middle Atlantic"
# sub$REG16[sub$REG16==3 ] <- "East North Central"
# sub$REG16[sub$REG16==4 ] <- "West North Central"
# sub$REG16[sub$REG16==5 ] <- "South Atlantic"
# sub$REG16[sub$REG16==6 ] <- "East South Central"
# sub$REG16[sub$REG16==7 ] <- "West South Central"
# sub$REG16[sub$REG16==8 ] <- "Mountain"
# sub$REG16[sub$REG16==9 ] <- "Pacific"

# Step 1: Read the shapefile into R
us_shapefile <- st_read("States_shapefile.shp")

us <- us_shapefile[, c("State_Code", "geometry")]

# Step 2: Create custom regions
# For example, group states into custom regions such as "Mid Pacific"
state_to_region <- function(state) {
    if (state %in% c("MT", "ID", "WY", "UT", "CO", "AZ", "NM", "NV")) {
        return("Mountain")
    } else if (state %in% c("ND", "SD", "MN", "NE", "IA", "MO", "KS")) {
        return("West North Central")
    } else if (state %in% c("OH", "IN", "IL", "MI", "WI")) {
        return("East North Central")
    } else if (state %in% c("ME", "VT", "NH", "MA", "CT", "RI")) {
        return("New England")
    } else if (state %in% c("NY", "NJ", "PA")) {
        return("Middle Atlantic")
    } else if (state %in% c("DE", "MD", "VA", "WV", "NC", "SC", "GA", "FL", "DC")) {
        return("South Atlantic")
    } else if (state %in% c("KY", "TN", "MS", "AL")) {
        return("East South Central")
    } else if (state %in% c("TX", "OK", "AR", "LA")) {
        return("West South Central")
    } else if (state %in% c("CA", "WA", "OR", "HI", "AK")) {
        return("Pacific")
    } else {
        return(NA)
    }
}

us$REGION <- sapply(us$State_Code, state_to_region)
sub$REGION <- as.character(sub$REGION)

percentages <- sub %>%
    group_by(REGION, FAIRHWRK, REG16) %>%
    summarize(count = n()) %>%
    mutate(total_count = sum(count), percentage = count / total_count * 100) %>%
    ungroup()

percentages_wide <- percentages %>%
    pivot_wider(
        names_from = FAIRHWRK,
        values_from = percentage,
        names_prefix = "FAIRHWRK_"
    )

us_merged <- left_join(us, percentages_wide, by = "REGION")

us_merged_clean <- us_merged %>%
    filter(!is.na(FAIRHWRK_1))
    #filter(!is.na(REG16))
```

```{r}
# Adjust the palette as needed (e.g., "YlOrRd", "Blues", "Greens")
pal <- colorNumeric(palette = "YlOrRd", domain = us_merged_clean$FAIRHWRK_1)

# Create the Leaflet map
leaflet(data = us_merged_clean) %>%
    addTiles() %>%
    addPolygons(
        # Set the fill color based on the values of FAIRHWRK_1
        fillColor = ~pal(FAIRHWRK_1),
        color = "black",  # Border color
        weight = 1,  # Border weight
        fillOpacity = 0.7,  # Opacity of the filled area
        smoothFactor = 0.5,  # Smoothness of polygon edges
        # Define the pop-up content to display the region and FAIRHWRK_1 value
        popup = ~paste0("Region: ", REGION, "<br>Both Fair Division of Work: ", round(FAIRHWRK_1, 2), "%")
    ) %>%
    # Add a legend to the map
    addLegend(
        pal = pal,
        values = ~FAIRHWRK_1,
        title = "Fairness of Work for Both (%)",
        position = "bottomright"
    )

```